 \chapter{Analyse af XML struktur}
\label{sec:analyse_xml_struktur}

\section{Formål}
\label{sec:Formaal_xml_analyse}
At gennemskue, og udlede strukturen af et xml dokument kan være en stor opgave, især for et stort dokument med mange elementer. I tilfældet med \fil{resource.xml}, som indeholder utroligt meget data, kan strukturen ikke gennemskues ved en simpel gennemlæsning af filen. 
Alternativet kan være at oprette en database i \prg{BaseX}, og ved brug af en række \lang{XQuery} forspørgelser kan der samles nok informationer om elementerne i xml'en, til at kunne beskrive strukturen. Dette kan forfines yderligere ved at udvikle en \lang{XQuery} funktion, der kan finde alle de ønskede oplysninger på en gang, og på en struktureret vis returnere de ønskede metadata for xml strukturen. 

\section{Design af analyse funktion}
\label{sec:DesignAfAnalyseFunktion}
Resultatet af analysen skal være en xml struktur, der beskriver de elementer som input xmlen består af. Figur \ref{code:struktur_metadata-xml} viser det ønskede resultat, hvor informationer om et element angives som attributter til elementet \xmlelm{element}, og informationer om dets attributer som \xmlelm{attribute} elementer efterfulgt af information om dets efterfølgerer som angives som nestede elementer af samme type. **HUSK** eksempel som bilag hvor der rent faktisk er attributter. **HUSK**
\begin{figure}[hbt]
\centering
\begin{BVerbatim}
<elements>
  <element name="" maxlength="" card="">
      <attribute name=""/>
    <element name="" maxlength="" card=""/>
	</element>
</elements>
\end{BVerbatim}
\caption{Struktur for genereret metadata-xml}
\label{code:struktur_metadata-xml}
\end{figure}

For \xmlatt{maxlength} gælder det at den kun udfyldes for elementer med en text() node. Virkemåden for \xmlatt{maxlength} er ikke defineret for elementer med mixed-content, og da den pågældende xml fra \fil{resource.xml} ikke indeholder mixed-content, bliver dette tilfælde ikke behandlet yderligere.

Atributten \xmlatt{card} udfyldes med notationene \verb|1:1, 0:1, 0:n, m:n| og dækker de normale muligheder for kardinalitet.

Funktionen \funk{local:analyze} begynder analysen ved input elementets børn, og returnerer derfor ingen oplysninger om input elementet. Det betyder at en analyse af et helt xml dokument, eller fragment, bør startes med kaldet \verb|local:analyze(/)|, altså med dokumentroden som parameter. Dette skyldes at f.eks. kardinalitets analysen kræver information om hvilken kontekst elementerne optræder i.

Funktionen \funk{local:analyze} er en wrapper funktion til \funk{local:analyze2}, som er den rekursive funktion der reelt behandler xml strukturen. For hvert niveau skal alle tags med samme navn behandles og analyseres samlet, og derfor opbygges en liste af fundne elementnavne i linie \lref{04}.
Elementerne grupperes udfra deres navne for at gøre det muligt at udføre en generel analyse, og dermed være i stand til at udlede oplysninger om element. finde alle mulige efterkommere, samt den maksimale længde for en vilkårlig text node under elementer med dette navn.
*TODO* beskriv at alle elementer med samme navn på samme sted i strukturen betragtes som samme type, og derfor er en generel analyse vigtig/korrekt. *TODO*

Attributen \xmlatt{name} er simpel at finde værdien for, mens de to andre er en smule mere komplicerede. Derfor er der skrevet  hjælpefunktionerne \funk{local:analyze\_maxlength} og \funk{local:analyze\_card}. Resultatet fra disse funktioner, som kaldes i linie \lref{06} og \lref{07}, tilføjes xml strukturen som attributter. Den sidste funktion \funk{local:analyze\_attributes} finder alle de attributer der findes til elementet, samt deres maksimale længde, og for hver attribut tilføjes et element. *TODO* referer til indsat eksempel istedetfor at beskrive hvordan det tilføjes til strukturen.... *TODO*  

\begin{figure}[ht]
\centering
\begin{BVerbatim}
01: declare function local:analyze2($elements as item()*)
02: as element()*
03: { 
04:    let $names :=  distinct-values($elements/*/name())
05:    for $el in $names 
06:    let  $maxlength := local:analyze_maxlength($elements/*[name()=$el])
07:    let $card := local:analyze_card($elements,$el)
08:    return 
09:    <element name='{$el}' maxlength='{$maxlength}' card='{$card}'>
10:        {local:analyze_attributes($elements/*[name()=$el])}
11:        {local:analyze2($elements/*[name()=$el])}
12:    </element>
13: };
\end{BVerbatim}
\caption{Den rekursive funktion 'local:analyze2'}
\label{code:func_analyze}
\end{figure}



















\begin{figure}[ht]
\centering
\begin{BVerbatim}
<elements>
  <element name="root" maxlength="" card="1:1">
    <element name="resource" maxlength="" card="(1741)m:n(1741)">
      <element name="ID" maxlength="4" card="1:1"/>
      <element name="title" maxlength="107" card="1:1"/>
      <element name="description" maxlength="500" card="1:1"/>
      <element name="itemdate" maxlength="" card="1:1">
        <element name="recordcreated" maxlength="10" card="1:1"/>
        <element name="placedonline" maxlength="10" card="1:1"/>
      </element>
      <element name="identifier" maxlength="" card="1:1">
        <element name="url" maxlength="195" card="1:1"/>
      </element>
      <element name="publisher" maxlength="" card="1:1">
        <element name="name" maxlength="68" card="1:1"/>
        <element name="agency" maxlength="58" card="1:1"/>
      </element>
      <element name="image" maxlength="" card="1:1">
        <element name="url" maxlength="71" card="1:1"/>
        <element name="caption" maxlength="95" card="1:1"/>
        <element name="alttext" maxlength="200" card="1:1"/>
        <element name="sourceurl" maxlength="200" card="1:1"/>
      </element>
      <element name="interestingfact" maxlength="" card="1:1">
        <element name="url" maxlength="200" card="1:1"/>
        <element name="text" maxlength="523" card="1:1"/>
      </element>
      <element name="subjects" maxlength="" card="1:1">
        <element name="subject" maxlength="" card="(1)m:n(30)">
          <element name="category" maxlength="27" card="1:1"/>
          <element name="subcategory" maxlength="57" card="1:1"/>
          <element name="primary" maxlength="3" card="1:1"/>
        </element>
      </element>
      <element name="resourcekeywords" maxlength="" card="0:1">
        <element name="keywords" maxlength="" card="1:1">
          <element name="term" maxlength="40" card="(1)m:n(19)"/>
        </element>
      </element>
    </element>
  </element>
</elements>
\end{BVerbatim}
\caption{Resultat fra kørsel af xml analyse}
\label{code:xml_analyse_result}
\end{figure}


